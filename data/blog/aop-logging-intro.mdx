---
title: â€™ìš”ì²­ë¶€í„° ë ˆí¬ì§€í† ë¦¬ê¹Œì§€, í•œëˆˆì— íŒŒì•…í•˜ëŠ” ê³„ì¸µí˜• ë¡œê¹… ì‹œìŠ¤í…œ êµ¬ì¶•ê¸°â€™
date: '2024-06-06'
summary: â€™Logging with Spring AOPâ€™
tags: [â€™springâ€™, â€™aopâ€™, â€™loggingâ€™]
draft: false
---

ê°œë°œì„ í•˜ë‹¤ ë³´ë©´ â€œì´ ìš”ì²­ì€ ëŒ€ì²´ ì–´ë””ì„œ ë§‰ížŒ ê±¸ê¹Œ?â€, â€œì´ ì—ëŸ¬ëŠ” ì–´ë–¤ íŒŒë¼ë¯¸í„° ë•Œë¬¸ì— ë°œìƒí–ˆì„ê¹Œ?â€ë¼ëŠ” ì§ˆë¬¸ì„ ìˆ˜ì—†ì´ ë˜ì§€ê²Œ ë©ë‹ˆë‹¤. ë‹¨ìˆœí•œ `log.info()`ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•¨ì„ ëŠê»´, **Filterì™€ AOP, ê·¸ë¦¬ê³  MDC**ë¥¼ ì¡°í•©í•˜ì—¬ ìš”ì²­ì˜ ì „ì²´ íë¦„ì„ ì‹œê°ì ìœ¼ë¡œ íŒŒì•…í•  ìˆ˜ ìžˆëŠ” ë¡œê¹… ì‹œìŠ¤í…œì„ êµ¬ì¶•í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.

---

## 1. ì™œ ì´ëŸ° ë¡œê¹… ì‹œìŠ¤í…œì´ í•„ìš”í•œê°€?

ê¸°ë³¸ì ì¸ ë¡œê·¸ëŠ” ì‹œê°„ ìˆœì„œëŒ€ë¡œ ìŒ“ì¼ ë¿, íŠ¹ì • ìš”ì²­ì´ ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–¤ ì„œë¹„ìŠ¤ì™€ ë ˆí¬ì§€í† ë¦¬ë¥¼ ê±°ì¹˜ëŠ”ì§€ í•œëˆˆì— ë³´ê¸° ì–´ë µìŠµë‹ˆë‹¤. íŠ¹ížˆ ë©€í‹° ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œëŠ” ì—¬ëŸ¬ ìš”ì²­ì˜ ë¡œê·¸ê°€ ë’¤ì„žì—¬ ì¶”ì ì´ ê±°ì˜ ë¶ˆê°€ëŠ¥í•´ì§€ì£ .

ì´ë²ˆ ìž‘ì—…ì„ í†µí•´ í•´ê²°í•˜ê³ ìž í–ˆë˜ í•µì‹¬ ëª©í‘œëŠ” ì„¸ ê°€ì§€ì˜€ìŠµë‹ˆë‹¤.

1. **íŠ¸ëž˜í”½ ë¶„ì„:** ìš”ì²­/ì‘ë‹µ ë°”ë””ë¥¼ í¬í•¨í•œ ì „ì²´ HTTP íŠ¸ëž˜í”½ í™•ì¸.
2. **ë¡œì§ ì¶”ì :** ê³„ì¸µ(Controller-Service-Repo) ê°„ì˜ í˜¸ì¶œ ê´€ê³„ ê°€ì‹œí™”.
3. **ë§¥ë½(Context) ìœ ì§€:** ê³ ìœ  ìš”ì²­ IDë¥¼ ëª¨ë“  ë¡œê·¸ì— ë‚¨ê²¨ í©ì–´ì§„ ë¡œê·¸ë¥¼ í•˜ë‚˜ë¡œ ë¬¶ê¸°.

---

## 2. HTTP ìš”ì²­ì˜ ì‹œìž‘ê³¼ ë: Filter ê¸°ë°˜ ë¡œê¹…

ê°€ìž¥ ë¨¼ì € ìš”ì²­ì˜ ìž…êµ¬ì¸ `Filter`ì—ì„œ URI, ë©”ì„œë“œ, ë°”ë””, ê·¸ë¦¬ê³  ì²˜ë¦¬ ì‹œê°„ì„ ê¸°ë¡í•˜ë„ë¡ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.

### ê¸°ìˆ ì  í¬ì¸íŠ¸: â€œì´ë¯¸ ì½ì–´ë²„ë¦° ë°”ë””ëŠ” ë‹¤ì‹œ ì½ì„ ìˆ˜ ì—†ë‹¤â€

Servletì˜ `InputStream`ì€ í•œ ë²ˆ ì½ìœ¼ë©´ ì†Œëª¨ë˜ì–´ ë²„ë¦½ë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Springì´ ì œê³µí•˜ëŠ” `ContentCachingRequestWrapper`ë¥¼ ë„ìž…í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¡œê·¸ë¥¼ ë‚¨ê¸°ë©´ì„œë„ ì»¨íŠ¸ë¡¤ëŸ¬ì— ë°”ë””ë¥¼ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•  ìˆ˜ ìžˆì—ˆìŠµë‹ˆë‹¤.

```java
package com.graydang.app.global.logging.filter;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.ObjectWriter;
import com.graydang.app.global.logging.config.LoggingProperties;
import jakarta.servlet.*;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.web.util.ContentCachingRequestWrapper;
import org.springframework.web.util.ContentCachingResponseWrapper;

import java.io.IOException;
import java.nio.charset.StandardCharsets;

@Component
@RequiredArgsConstructor
public class HttpRequestLoggingFilter implements Filter {

    private static final Logger log = LoggerFactory.getLogger(HttpRequestLoggingFilter.class);
    private static final int MAX_LOG_LENGTH = 1024;
    private static final ObjectWriter PRETTY_PRINTER = new ObjectMapper().writerWithDefaultPrettyPrinter();
    private final LoggingProperties loggingProperties;

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        // ì„¤ì •ì— ë”°ë¼ HTTP ë¡œê¹… í™œì„±í™” ì—¬ë¶€ ê²°ì •
        if (!loggingProperties.getHttpRequest()) {
            chain.doFilter(request, response);
            return;
        }

        if (!(request instanceof HttpServletRequest) || !(response instanceof HttpServletResponse)) {
            chain.doFilter(request, response);
            return;
        }

        ContentCachingRequestWrapper httpRequest = new ContentCachingRequestWrapper((HttpServletRequest) request);
        ContentCachingResponseWrapper httpResponse = new ContentCachingResponseWrapper((HttpServletResponse) response);

        String method = httpRequest.getMethod();
        String uri = httpRequest.getRequestURI();

        log.info("[HTTP] START {} {}", method, uri);

        long start = System.currentTimeMillis();
        try {
            chain.doFilter(httpRequest, httpResponse);
        } finally {
            long duration = System.currentTimeMillis() - start;
            logBody(httpRequest, httpResponse, duration, uri);
            httpResponse.copyBodyToResponse(); // ìºì‹±ëœ ë°”ë””ë¥¼ ì‹¤ì œ ì‘ë‹µ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë³µì‚¬
        }
    }

    private void logBody(ContentCachingRequestWrapper request, ContentCachingResponseWrapper response, long duration, String uri) {
        // ë°”ë”” ì¶”ì¶œ ë° Pretty Print ë¡œì§ (ì¤‘ëžµ)
        log.info("[HTTP] END {} {} ({} ms)", response.getStatus(), uri, duration);
    }
}
```

---

## 3. ê³„ì¸µ ê°„ íë¦„ì„ ì‹œê°í™”í•˜ëŠ” Indent ë¡œê¹… (AOP)

ë¡œê·¸ì˜ í˜¸ì¶œ ê´€ê³„ë¥¼ í•œëˆˆì— íŒŒì•…í•˜ê¸° ìœ„í•´ **Indent(ë“¤ì—¬ì“°ê¸°)** ë°©ì‹ì„ ë„ìž…í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ ë°˜ë³µë˜ëŠ” ë¡œì§ì„ `LoggingSupport` ì¶”ìƒ í´ëž˜ìŠ¤ì— ëª¨ì•˜ìŠµë‹ˆë‹¤.

### ì„¤ê³„ ì „ëžµ: MDC í™œìš©

`MDC(Mapped Diagnostic Context)`ì— í˜„ìž¬ í˜¸ì¶œì˜ ê¹Šì´(`logDepth`)ë¥¼ ì €ìž¥í•˜ì—¬, ë©”ì„œë“œì— ì§„ìž…í•  ë•Œë§ˆë‹¤ ë“¤ì—¬ì“°ê¸°ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

```java
package com.graydang.app.global.logging.util;

import com.graydang.app.global.logging.config.LoggingProperties;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.JoinPoint;
import org.slf4j.MDC;

@Slf4j
@RequiredArgsConstructor
public abstract class LoggingSupport {

    private static final String LOG_DEPTH_KEY = "logDepth";
    private final LoggingProperties loggingProperties;

    protected void increaseDepth() {
        String depthStr = MDC.get(LOG_DEPTH_KEY);
        int depth = depthStr != null ? Integer.parseInt(depthStr) : 0;
        MDC.put(LOG_DEPTH_KEY, String.valueOf(depth + 1));
    }

    protected void decreaseDepth() {
        String depthStr = MDC.get(LOG_DEPTH_KEY);
        int depth = depthStr != null ? Integer.parseInt(depthStr) : 1;
        MDC.put(LOG_DEPTH_KEY, String.valueOf(Math.max(0, depth - 1)));
    }

    protected void logMethodEntry(JoinPoint joinPoint, String layer) {
        if (!loggingProperties.getEnabled()) return;
        increaseDepth();
        String indent = "  ".repeat(getCurrentDepth());
        log.info("{}[{}] ENTER => {}", indent, layer, joinPoint.getSignature().toShortString());
    }

    protected void logMethodExit(JoinPoint joinPoint, Object result, String layer) {
        if (!loggingProperties.getEnabled()) return;
        String indent = "  ".repeat(getCurrentDepth());
        log.info("{}[{}] RETURN <= {}", indent, layer, joinPoint.getSignature().toShortString());
        decreaseDepth();
    }
}
```

---

## 4. ë¡œê·¸ì— â€™ë§¥ë½â€™ì„ ë”í•˜ë‹¤: Trace IDì™€ User ID

ë¡œê·¸ê°€ ì•„ë¬´ë¦¬ ì •ëˆë˜ì–´ë„ â€œì´ê²Œ ì–´ëŠ ìš”ì²­ì—ì„œ ì‹œìž‘ëœ ê±´ê°€?â€ë¥¼ ëª¨ë¥´ë©´ ì˜ë¯¸ê°€ ì—†ìŠµë‹ˆë‹¤. `JwtFilter`ì—ì„œ ë‘ ê°€ì§€ ì •ë³´ë¥¼ MDCì— ì£¼ìž…í•˜ì—¬ ëª¨ë“  ë¡œê·¸ ë¼ì¸ì˜ ì•žì— ë¶™ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

1. **requestId (UUID):** ìš”ì²­ë§ˆë‹¤ ê³ ìœ  IDë¥¼ ìƒì„±í•´ í•˜ë‚˜ì˜ ìš”ì²­ì´ ë§Œë“œëŠ” ë¡œê·¸ë“¤ì„ ê·¸ë£¹í•‘í•©ë‹ˆë‹¤.
2. **userId:** ë¡œê·¸ì¸í•œ ì‚¬ìš©ìžì˜ ì •ë³´ë¥¼ ë‚¨ê²¨ ìž¥ì•  ëŒ€ì‘ ì‹œ íŠ¹ì • ì‚¬ìš©ìžì˜ íë¦„ë§Œ ì¶”ì í•©ë‹ˆë‹¤.

```java
// JwtFilterì˜ doFilterInternal ë‚´ë¶€
String requestUri = request.getRequestURI();
MDC.put("requestUri", requestUri);
MDC.put("requestId", UUID.randomUUID().toString()); // Trace ID ìƒì„±

// ì¸ì¦ ì„±ê³µ ì‹œ
MDC.put("userId", String.valueOf(userId));
```

---

## 5. ìš´ì˜ í™˜ê²½ì„ ê³ ë ¤í•œ ì„±ëŠ¥ ìµœì í™”

ë¡œê¹…ì€ ë¹„ìš©ìž…ë‹ˆë‹¤. íŠ¹ížˆ ë°”ë””ë¥¼ ë§¤ë²ˆ ë¬¸ìžì—´ë¡œ ë³€í™˜í•˜ê³  JSONìœ¼ë¡œ íŒŒì‹±í•˜ëŠ” ìž‘ì—…ì€ ìš´ì˜ í™˜ê²½ì—ì„œ ì˜¤ë²„í—¤ë“œê°€ í½ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ `application.yml` ì„¤ì •ì„ í†µí•´ í™˜ê²½ë³„ë¡œ ë¡œê¹… ì˜µì…˜ì„ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.

YAML

```YAML
# application-prod.yml
logging:
  custom:
    enabled: true        # ê³„ì¸µí˜• ë¡œê¹…ì€ ìœ ì§€
    http-request: false  # ìš´ì˜í™˜ê²½ì—ì„œëŠ” ë¬´ê±°ìš´ HTTP ë°”ë”” ë¡œê¹… ë¹„í™œì„±í™”
```

---

## 6. ë§ˆì¹˜ë©°: ê²°ê³¼ë¬¼ê³¼ êµí›ˆ

ì‹œìŠ¤í…œì„ ì ìš©í•œ í›„, ë¡œê·¸ëŠ” ì•„ëž˜ì™€ ê°™ì´ ì§ê´€ì ìœ¼ë¡œ ë³€í–ˆìŠµë‹ˆë‹¤.

Plaintext

```bash
[7a2f...] [userId=123] [CONTROLLER] ENTER => PostController.create()
[7a2f...] [userId=123]   [SERVICE] ENTER => PostService.save()
[7a2f...] [userId=123]     [REPOSITORY] ENTER => PostRepository.save()
[7a2f...] [userId=123]     [REPOSITORY] RETURN <= PostRepository.save()
[7a2f...] [userId=123]   [SERVICE] RETURN <= PostService.save()
[7a2f...] [userId=123] [CONTROLLER] RETURN <= PostController.create()
```

### ðŸ§ ë°°ìš´ ì 

- **MDCì˜ ìƒëª…ì£¼ê¸° ê´€ë¦¬:** MDCëŠ” `ThreadLocal` ê¸°ë°˜ì´ë¯€ë¡œ ìš”ì²­ì´ ëë‚˜ë©´ ë°˜ë“œì‹œ `MDC.clear()`ë¥¼ í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ìŠ¤ë ˆë“œ í’€ í™˜ê²½ì—ì„œ ë‹¤ë¥¸ ì‚¬ìš©ìžì˜ ìš”ì²­ì— ì´ì „ ë°ì´í„°ê°€ ë‚¨ëŠ” ì‹¬ê°í•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
- **ì˜ˆì™¸ ì²˜ë¦¬ ë¡œê¹…ì˜ ì¤‘ìš”ì„±:** ì„±ê³µì ì¸ ë°˜í™˜ë¿ë§Œ ì•„ë‹ˆë¼ ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ `decreaseDepth()`ê°€ í˜¸ì¶œë˜ë„ë¡ `AfterThrowing` ì–´ë“œë°”ì´ìŠ¤ë¥¼ ê¼¼ê¼¼ížˆ ì±™ê¸°ëŠ” ê²ƒì´ ê³„ì¸µ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ëŠ” í•µì‹¬ì´ì—ˆìŠµë‹ˆë‹¤.

ë‹¨ìˆœížˆ ê¸°ë¡í•˜ëŠ” ê²ƒì„ ë„˜ì–´, **ì˜ë¯¸ ìžˆëŠ” ë°ì´í„°**ë¥¼ ë‚¨ê¸°ëŠ” ë¡œê¹… ì‹œìŠ¤í…œ êµ¬ì¶•ê¸°ì˜€ìŠµë‹ˆë‹¤.
